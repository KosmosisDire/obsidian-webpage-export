import esbuild from "esbuild";
import process from "process";
import builtins from "builtin-modules";
import fs from "fs";
import path from "path";
import { solidPlugin } from "esbuild-plugin-solid";

const banner =
`/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

// let outputFolder = 'C:\\Main\\Obsidian\\Export Development\\.obsidian\\plugins\\webpage-html-export\\';
let outputFolder = "C:\\Main\\Obsidian\\Development\\.obsidian\\plugins\\webpage-html-export\\";

const prod = (process.argv[2] === 'production');
const dev = !prod;

// Common build options
const commonOptions = {
	banner: { js: banner },
	logLevel: "info",
	sourcemap: prod ? false : 'inline',
	treeShaking: true,
};

// Plugin build
const pluginBuildOptions = {
	...commonOptions,
	loader: {
		'.txt.js': 'text',
		'.txt.css': 'text',
		'.wasm': 'binary',
		'.png': 'binary',
	},
	entryPoints: ['src/plugin/main.ts'],
	bundle: true,
	tsconfig: 'tsconfig.json',
	external: [
		'obsidian',
		'electron',
		'@codemirror/autocomplete',
		'@codemirror/collab',
		'@codemirror/commands',
		'@codemirror/language',
		'@codemirror/lint',
		'@codemirror/search',
		'@codemirror/state',
		'@codemirror/view',
		'@lezer/common',
		'@lezer/highlight',
		'@lezer/lr',
		'node:buffer',
		'node:stream',
		...builtins
	],
	format: 'cjs',
	target: 'es2018',
	plugins: [solidPlugin()],
	alias: {
		'@shared': path.resolve('src/shared'),
	},
	outfile: outputFolder + 'main.js'
};

// Frontend build options
const frontendBuildOptions = {
	...commonOptions,
	entryPoints: ['src/frontend/index.tsx'],
	bundle: true,
	format: 'iife',
	globalName: 'WebpageExport',
	target: 'es2018',
	outfile: 'src/frontend/dist/main.js',
	plugins: [solidPlugin()],
	alias: {
		'@shared': path.resolve('src/shared'),
	},
	define: {
		'process.env.NODE_ENV': prod ? '"production"' : '"development"',
	},
};

// Copy files function
function copyFiles() {
	if (!fs.existsSync('src/frontend/dist')) {
		fs.mkdirSync('src/frontend/dist', { recursive: true });
	}
	
	if (!fs.existsSync('src/frontend/dist/styles')) {
		fs.mkdirSync('src/frontend/dist/styles', { recursive: true });
	}
	
	fs.copyFileSync('src/frontend/index.html', 'src/frontend/dist/index.html');
	fs.copyFileSync('src/frontend/styles/main.css', 'src/frontend/dist/styles/main.css');
	fs.copyFileSync('src/frontend/styles/new.css', 'src/frontend/dist/styles/new.css');
}

if (dev) {
	// Development mode with watch
	const pluginCtx = await esbuild.context(pluginBuildOptions);
	const frontendCtx = await esbuild.context(frontendBuildOptions);
	
	await pluginCtx.watch();
	await frontendCtx.watch();
	
	copyFiles();
	
	// Watch for HTML/CSS changes
	fs.watchFile('src/frontend/index.html', () => {
		copyFiles();
		console.log('HTML file updated');
	});
	
	fs.watchFile('src/frontend/styles/main.css', () => {
		copyFiles();
		console.log('CSS file updated');
	});

	fs.watchFile('src/frontend/styles/new.css', () => {
		copyFiles();
		console.log('CSS file updated');
	});

	console.log('Watching for changes...');
} else {
	// Production build
	await esbuild.build(pluginBuildOptions).catch(() => process.exit(1));
	await esbuild.build(frontendBuildOptions).catch(() => process.exit(1));
	
	copyFiles();
	console.log('Frontend build completed');
}
